import React, { useState, useEffect, useRef } from 'react';
import { MessageCircle, Send, X, Bot, User } from 'lucide-react';

interface Message {
  id: string;
  text: string;
  sender: 'user' | 'ai';
  timestamp: number;
}

interface FloatingButtonProps {
  onPositionChange?: (x: number, y: number) => void;
  initialPosition?: { x: number; y: number };
}

const FloatingButton: React.FC<FloatingButtonProps> = () => {
  // æ‰€æœ‰ useState hooks å¿…é¡»åœ¨é¡¶å±‚
  const [isExpanded, setIsExpanded] = useState(() => {
    try {
      const savedState = (window as any).__FLOATING_EXPANDED__ || false;
      console.log('FloatingButton: ä»å…¨å±€å˜é‡æ¢å¤å±•å¼€çŠ¶æ€:', savedState);
      return savedState;
    } catch (e) {
      console.error('FloatingButton: æ¢å¤çŠ¶æ€å¤±è´¥:', e);
      return false;
    }
  });

  const [messages, setMessages] = useState<Message[]>(() => {
    try {
      return (window as any).__FLOATING_MESSAGES__ || [];
    } catch (e) {
      return [];
    }
  });

  const [inputText, setInputText] = useState('');
  const [isSubmitting, setIsSubmitting] = useState(false);
  const [isDragging, setIsDragging] = useState(false);

  // æ‰€æœ‰ useRef hooks å¿…é¡»åœ¨é¡¶å±‚
  const buttonRef = useRef<HTMLDivElement>(null);
  const inputRef = useRef<HTMLInputElement>(null);
  const messagesRef = useRef<HTMLDivElement>(null);

  // æ‰€æœ‰ useEffect hooks å¿…é¡»åœ¨é¡¶å±‚

  // 1. èƒŒæ™¯æ§åˆ¶ useEffect
  useEffect(() => {
    if (isExpanded) {
      console.log('FloatingButton: å±•å¼€çŠ¶æ€ - è®¾ç½®é»‘è‰²èƒŒæ™¯');
      document.documentElement.style.background = 'black';
      document.body.style.background = 'black';
      const root = document.getElementById('floating-root');
      if (root) root.style.background = 'black';
    } else {
      console.log('FloatingButton: æ”¶èµ·çŠ¶æ€ - æ¢å¤çº¢è‰²èƒŒæ™¯');
      document.documentElement.style.background = '#FF0000';
      document.body.style.background = '#FF0000';
      const root = document.getElementById('floating-root');
      if (root) root.style.background = '#FF0000';
    }
  }, [isExpanded]);

  // 2. çŠ¶æ€æŒä¹…åŒ– useEffect
  useEffect(() => {
    try {
      (window as any).__FLOATING_EXPANDED__ = isExpanded;
      console.log('FloatingButton: ä¿å­˜å±•å¼€çŠ¶æ€åˆ°å…¨å±€å˜é‡:', isExpanded);
    } catch (e) {
      console.error('FloatingButton: ä¿å­˜çŠ¶æ€å¤±è´¥:', e);
    }
  }, [isExpanded]);

  // 3. æ¶ˆæ¯æŒä¹…åŒ– useEffect
  useEffect(() => {
    try {
      (window as any).__FLOATING_MESSAGES__ = messages;
      console.log('FloatingButton: ä¿å­˜èŠå¤©æ¶ˆæ¯åˆ°å…¨å±€å˜é‡ï¼Œæ¶ˆæ¯æ•°é‡:', messages.length);
    } catch (e) {
      console.error('FloatingButton: ä¿å­˜æ¶ˆæ¯å¤±è´¥:', e);
    }
  }, [messages]);

  // 4. åˆå§‹åŒ–æ¬¢è¿æ¶ˆæ¯ useEffect
  useEffect(() => {
    console.log('FloatingButton: æ£€æŸ¥æ˜¯å¦éœ€è¦åˆå§‹åŒ–æ¬¢è¿æ¶ˆæ¯');
    const existingMessages = (window as any).__FLOATING_MESSAGES__ || [];
    if (existingMessages.length === 0) {
      console.log('FloatingButton: æ²¡æœ‰æŒä¹…åŒ–æ¶ˆæ¯ï¼Œæ·»åŠ æ¬¢è¿æ¶ˆæ¯');
      const welcomeMessage: Message = {
        id: 'welcome',
        text: 'ä½ å¥½ï¼æˆ‘æ˜¯AIåŠ©æ‰‹ï¼Œæœ‰ä»€ä¹ˆå¯ä»¥å¸®åŠ©æ‚¨çš„å—ï¼Ÿ',
        sender: 'ai',
        timestamp: Date.now(),
      };
      setMessages([welcomeMessage]);
      console.log('FloatingButton: æ¬¢è¿æ¶ˆæ¯å·²è®¾ç½®');
    }
  }, []);

  // 5. çª—å£å¤§å°æ¢å¤ useEffect
  useEffect(() => {
    console.log('FloatingButton: AIèŠå¤©ç»„ä»¶æŒ‚è½½å®Œæˆ');
    const savedState = (window as any).__FLOATING_EXPANDED__;
    if (savedState) {
      console.log('FloatingButton: æ£€æµ‹åˆ°ä¿å­˜çš„å±•å¼€çŠ¶æ€ï¼Œæ¢å¤çª—å£å¤§å°');
      (window as any).electronAPI?.resizeFloatingWindow?.(800, 600);
    }
  }, []);

  // 6. è¾“å…¥æ¡†èšç„¦ useEffect
  useEffect(() => {
    if (isExpanded && inputRef.current) {
      inputRef.current.focus();
    }
  }, [isExpanded]);

  // 7. æ¶ˆæ¯æ»šåŠ¨ useEffect
  useEffect(() => {
    if (messagesRef.current) {
      messagesRef.current.scrollTop = messagesRef.current.scrollHeight;
    }
  }, [messages]);

  // 8. é”®ç›˜äº‹ä»¶ useEffect
  useEffect(() => {
    const handleKeyDown = (e: KeyboardEvent) => {
      if (!isExpanded) return;
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        handleSubmit();
      }
      if (e.key === 'Escape') {
        handleClose();
      }
    };

    document.addEventListener('keydown', handleKeyDown);
    return () => document.removeEventListener('keydown', handleKeyDown);
  }, [isExpanded, inputText]);

  // äº‹ä»¶å¤„ç†å‡½æ•°
  const handleMouseDown = (e: React.MouseEvent) => {
    console.log('FloatingButton: é¼ æ ‡æŒ‰ä¸‹');
    if (isExpanded) return;

    e.preventDefault();
    const startX = e.clientX;
    const startY = e.clientY;
    let hasMoved = false;

    const handleMouseMove = (e: MouseEvent) => {
      const deltaX = e.clientX - startX;
      const deltaY = e.clientY - startY;

      if (Math.abs(deltaX) > 5 || Math.abs(deltaY) > 5) {
        hasMoved = true;
        setIsDragging(true);
        console.log('FloatingButton: æ‹–æ‹½ä¸­');
        (window as any).electronAPI?.moveFloatingWindow?.(
          e.screenX - 30,
          e.screenY - 30
        );
      }
    };

    const handleMouseUp = () => {
      console.log('FloatingButton: é¼ æ ‡é‡Šæ”¾ï¼ŒhasMoved:', hasMoved);
      document.removeEventListener('mousemove', handleMouseMove);
      document.removeEventListener('mouseup', handleMouseUp);

      setIsDragging(false);

      if (!hasMoved) {
        console.log('FloatingButton: ç‚¹å‡»å±•å¼€');
        setIsExpanded(true);
        console.log('FloatingButton: isExpanded è®¾ç½®ä¸º true');
        console.log('FloatingButton: messages é•¿åº¦:', messages.length);
        console.log('FloatingButton: å‡†å¤‡è°ƒæ•´çª—å£å¤§å°åˆ°å…¨å±');
        (window as any).electronAPI?.resizeFloatingWindow?.(800, 600);
        console.log('FloatingButton: çª—å£å¤§å°è°ƒæ•´è¯·æ±‚å·²å‘é€');
      }
    };

    document.addEventListener('mousemove', handleMouseMove);
    document.addEventListener('mouseup', handleMouseUp);
  };

  const handleClose = () => {
    setIsExpanded(false);
    setInputText('');
    (window as any).electronAPI?.resizeFloatingWindow?.(60, 60);
  };

  const handleSubmit = async () => {
    if (!inputText.trim() || isSubmitting) return;

    const userMessage: Message = {
      id: Date.now().toString(),
      text: inputText.trim(),
      sender: 'user',
      timestamp: Date.now(),
    };

    setMessages(prev => [...prev, userMessage]);
    setInputText('');
    setIsSubmitting(true);

    try {
      const aiResponse = await generateAIResponse(userMessage.text);

      const aiMessage: Message = {
        id: (Date.now() + 1).toString(),
        text: aiResponse,
        sender: 'ai',
        timestamp: Date.now(),
      };

      setMessages(prev => [...prev, aiMessage]);
    } catch (error) {
      console.error('Failed to get AI response:', error);
      const errorMessage: Message = {
        id: (Date.now() + 1).toString(),
        text: 'æŠ±æ­‰ï¼Œæˆ‘é‡åˆ°äº†ä¸€äº›é—®é¢˜ã€‚è¯·ç¨åå†è¯•ã€‚',
        sender: 'ai',
        timestamp: Date.now(),
      };
      setMessages(prev => [...prev, errorMessage]);
    } finally {
      setIsSubmitting(false);
    }
  };

  const generateAIResponse = async (userInput: string): Promise<string> => {
    await new Promise(resolve => setTimeout(resolve, 1000));

    const responses = [
      'æˆ‘ç†è§£æ‚¨çš„é—®é¢˜ï¼Œè®©æˆ‘æ¥å¸®åŠ©æ‚¨ã€‚',
      'è¿™æ˜¯ä¸€ä¸ªå¾ˆå¥½çš„é—®é¢˜ï¼Œæˆ‘æ¥ä¸ºæ‚¨è§£ç­”ã€‚',
      'æ ¹æ®æ‚¨çš„æè¿°ï¼Œæˆ‘å»ºè®®æ‚¨è€ƒè™‘ä»¥ä¸‹å‡ ç‚¹...',
      'æ„Ÿè°¢æ‚¨çš„æé—®ï¼Œè¿™é‡Œæ˜¯æˆ‘çš„å»ºè®®ï¼š',
      'æˆ‘å¾ˆä¹æ„å¸®åŠ©æ‚¨è§£å†³è¿™ä¸ªé—®é¢˜ã€‚',
    ];

    return responses[Math.floor(Math.random() * responses.length)] +
           `\n\næ‚¨æåˆ°ï¼š${userInput}\n\nè¿™ç¡®å®æ˜¯éœ€è¦ä»”ç»†è€ƒè™‘çš„é—®é¢˜ã€‚`;
  };

  // æ¸²æŸ“é€»è¾‘
  if (isExpanded) {
    console.log('FloatingButton: æ¸²æŸ“å±•å¼€ç•Œé¢ï¼Œmessages:', messages);
    return (
      <div style={{
        position: 'fixed',
        left: 0,
        top: 0,
        width: '100vw',
        height: '100vh',
        background: 'black',
        display: 'flex',
        alignItems: 'center',
        justifyContent: 'center',
        zIndex: 99999,
        pointerEvents: 'auto',
        overflow: 'hidden'
      }}>
        {/* æç«¯å¯è§æµ‹è¯•å…ƒç´  - ä¼˜åŒ–ç‰ˆæœ¬ */}
        <div
          onClick={handleClose}
          style={{
            position: 'absolute',
            top: '10px',
            left: '10px',
            width: 'calc(100% - 20px)',
            height: 'calc(100% - 20px)',
            fontSize: '24px',  // å‡å°å­—ä½“ç¡®ä¿æ˜¾ç¤º
            color: 'white',
            fontWeight: 'bold',
            backgroundColor: 'black',
            padding: '20px',
            border: '5px solid lime',
            outline: '3px solid orange',
            textShadow: '2px 2px 4px red',
            zIndex: 999999,
            display: 'flex',
            alignItems: 'flex-start',  // é¡¶éƒ¨å¯¹é½ç¡®ä¿å¯è§
            justifyContent: 'flex-start',  // å·¦å¯¹é½ç¡®ä¿å¯è§
            flexDirection: 'column',
            textAlign: 'left',
            cursor: 'pointer',
            overflow: 'visible'
          }}>
          <div style={{
            background: 'red',
            color: 'white',
            padding: '10px',
            marginBottom: '10px',
            fontSize: '20px',
            border: '2px solid yellow'
          }}>
            ğŸš€ REACT æˆåŠŸè¿è¡Œ! ğŸš€
          </div>
          <div style={{
            background: 'blue',
            color: 'white',
            padding: '10px',
            marginBottom: '10px',
            fontSize: '18px'
          }}>
            AIèŠå¤©ç•Œé¢æ­£å¸¸åŠ è½½
          </div>
          <div style={{
            background: 'green',
            color: 'white',
            padding: '10px',
            marginBottom: '10px',
            fontSize: '16px'
          }}>
            æ¶ˆæ¯æ•°é‡: {messages.length}
          </div>
          <div style={{
            background: 'purple',
            color: 'yellow',
            padding: '10px',
            fontSize: '14px',
            marginTop: 'auto'
          }}>
            ğŸ‘† ç‚¹å‡»ä»»æ„ä½ç½®å…³é—­ç•Œé¢ ğŸ‘†
          </div>
        </div>
      </div>
    );
  }

  // æ”¶èµ·çŠ¶æ€çš„æŒ‰é’®
  return (
    <div
      ref={buttonRef}
      onMouseDown={handleMouseDown}
      style={{
        width: '100%',
        height: '100%',
        borderRadius: '50%',
        background: 'linear-gradient(135deg, #3B82F6 0%, #1D4ED8 100%)',
        border: '3px solid rgba(255,255,255,0.3)',
        boxShadow: '0 10px 25px rgba(59,130,246,0.3)',
        cursor: 'pointer',
        display: 'flex',
        alignItems: 'center',
        justifyContent: 'center',
        pointerEvents: 'auto',
        transition: 'all 0.3s ease',
        position: 'relative'
      }}
      title="AIåŠ©æ‰‹ - ç‚¹å‡»å±•å¼€èŠå¤©ç•Œé¢"
      onMouseEnter={(e) => {
        e.currentTarget.style.transform = 'scale(1.1)';
        e.currentTarget.style.boxShadow = '0 15px 35px rgba(59,130,246,0.4)';
      }}
      onMouseLeave={(e) => {
        e.currentTarget.style.transform = 'scale(1)';
        e.currentTarget.style.boxShadow = '0 10px 25px rgba(59,130,246,0.3)';
      }}
    >
      <MessageCircle
        style={{
          width: '24px',
          height: '24px',
          color: 'white',
          filter: 'drop-shadow(0 2px 4px rgba(0,0,0,0.3))'
        }}
      />
    </div>
  );
};

export default FloatingButton;